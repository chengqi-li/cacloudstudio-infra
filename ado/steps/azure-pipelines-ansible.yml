trigger:
  branches:
    include:
      - main
  paths:
    include:
      - ansible/**

pr:
  branches:
    include:
      - main
  paths:
    include:
      - ansible/**

variables:
  ANSIBLE_DIR: ansible/web

stages:
  - stage: Ansible
    jobs:
      - job: AzureConnection
        displayName: "Export Azure VM information as environment variables"
        pool:
          vmImage: "ubuntu-latest"
        steps:
          - checkout: self
          - task: AzureKeyVault@2
            inputs:
              azureSubscription: "ADO Pipeline Connection"
              KeyVaultName: web-cacloud-keyvault # Hard-coded kv name
              SecretsFilter: "*"
              RunAsPreJob: true
          - script: |
              echo "Setting keyvault password as variable"
              echo "##vso[task.setvariable variable=AZURE_VM_PASSWORD;isOutput=true]$(web-0-secret)"
            displayName: "Get VM Password"
            name: GetVMPw

          - task: AzureCLI@2
            name: GetVMIp
            inputs:
              azureSubscription: "ADO Pipeline Connection"
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                ip=$(az network public-ip show \
                  --resource-group my-rg \
                  --name my-public-ip \
                  --query ipAddress \
                  --output tsv)

                echo "##vso[task.setvariable variable=AZURE_VM_IP;isOutput=true]$ip"
            displayName: "Get VM IP"

      - job: AnsibleRun
        displayName: "Run Ansible Playbook"
        dependsOn: AzureConnection
        steps:
          - script: |
              cd ..
              sudo apt-get update
              sudo apt-get install -y sshpass python3-pip
              pip3 install ansible
            displayName: "Install Ansible and sshpass"

          - script: |
              echo "Directory of Ansible inventory/playbook:"
              cd $(ANSIBLE_DIR)
              pwd
                  echo "Creating temporary Ansible inventory"
                  cat <<END > temp_inventory.yml
              webserver:
                hosts:
                  web:
                    ansible_host: $AZURE_VM_IP
                    ansible_user: $AZURE_VM_ADMINUSER
                    ansible_ssh_pass: $AZURE_VM_PASSWORD
                    ansible_python_interpreter: $PYTHON_PATH
                    ansible_ssh_common_args: "-o StrictHostKeyChecking=no"
              END
              export ANSIBLE_HOST_KEY_CHECKING=False
              ansible-playbook playbook.yml -i temp_inventory.yml --extra-vars "domain=$DOMAIN email=$EMAIL"
            displayName: "Run Ansible Playbook"
            env:
              AZURE_VM_IP: $(AZURE_VM_IP)
              AZURE_VM_ADMINUSER: "adminuser"
              AZURE_VM_PASSWORD: $(AZURE_VM_PASSWORD)
              PYTHON_PATH: "/usr/bin/python3"
              DOMAIN: "cacloudstudio.com"
              EMAIL: "anna.xing@cacloudstudio.com"
